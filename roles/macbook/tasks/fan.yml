- name: Installed
  become: yes
  package:
    name: mbpfan

- name: Service File Exists
  become: yes
  copy:
    src: mbpfan.service
    dest: /etc/systemd/system/mbpfan.service

- name: Service Enabled
  become: yes
  systemd:
    name: mbpfan.service
    enabled: yes
  register: enabled

- name: Systemd Config Reloaded
  become: yes
  systemd:
    daemon_reload: yes
  when: enabled.changed

- name: Start Service
  become: yes
  systemd:
    name: mbpfan.service
    state: started

- name: Get Minimum Speed
  shell:
    chdir: /sys/devices/platform/applesmc.768
    cmd: echo $(($(cat fan*_min | sort -n | head -1) + 500))
  register: speedmin
  changed_when: False

- name: Get Maximum Speed
  shell:
    chdir: /sys/devices/platform/applesmc.768
    cmd: cat fan*_max | sort -n | tail -1
  register: speedmax
  changed_when: False

- name: Get Maximum Temperature
  shell: echo $(($(cat /sys/devices/platform/coretemp.*/hwmon/hwmon*/temp*_max | sort -n | tail -1) / 1000))
  register: tempmax
  changed_when: False

- name: Set Minimum Speed
  become: yes
  lineinfile:
    path: /etc/mbpfan.conf
    regexp: 'min_fan1_speed = '
    line: 'min_fan1_speed = {{ speedmin.stdout }}'

- name: Set Maximum Speed
  become: yes
  lineinfile:
    path: /etc/mbpfan.conf
    regexp: 'max_fan1_speed = '
    line: 'max_fan1_speed = {{ speedmax.stdout }}'

- name: Set Maximum Temperature
  become: yes
  lineinfile:
    path: /etc/mbpfan.conf
    regexp: 'max_temp = '
    line: 'max_temp = {{ tempmax.stdout }}'

- name: Set Polling Interval
  become: yes
  lineinfile:
    path: /etc/mbpfan.conf
    regexp: 'polling_interval = '
    line: 'polling_interval = 2'
